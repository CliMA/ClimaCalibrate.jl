<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>G Ensemble Builder · ClimaCalibrate.jl</title><meta name="title" content="G Ensemble Builder · ClimaCalibrate.jl"/><meta property="og:title" content="G Ensemble Builder · ClimaCalibrate.jl"/><meta property="twitter:title" content="G Ensemble Builder · ClimaCalibrate.jl"/><meta name="description" content="Documentation for ClimaCalibrate.jl."/><meta property="og:description" content="Documentation for ClimaCalibrate.jl."/><meta property="twitter:description" content="Documentation for ClimaCalibrate.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaCalibrate.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../quickstart/">Getting Started</a></li><li><a class="tocitem" href="../literate_example/">Distributed Calibration Tutorial</a></li><li><a class="tocitem" href="../backends/">Backends</a></li><li><a class="tocitem" href="../submit_scripts/">Submission Scripts</a></li><li><a class="tocitem" href="../observations/">Observations</a></li><li><a class="tocitem" href="../observation_recipe/">Observation Recipes</a></li><li class="is-active"><a class="tocitem" href>G Ensemble Builder</a><ul class="internal"><li><a class="tocitem" href="#GEnsembleBuilder"><span><code>GEnsembleBuilder</code></span></a></li><li class="toplevel"><a class="tocitem" href="#Checkers"><span>Checkers</span></a></li><li><a class="tocitem" href="#Built-in-checkers"><span>Built-in checkers</span></a></li><li><a class="tocitem" href="#Implementing-custom-checkers"><span>Implementing custom checkers</span></a></li></ul></li><li><a class="tocitem" href="../emulate_sample/">Emulate and Sample</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>G Ensemble Builder</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>G Ensemble Builder</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCalibrate.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaCalibrate.jl/blob/main/docs/src/ensemble_builder.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Building-G-ensemble-matrix"><a class="docs-heading-anchor" href="#Building-G-ensemble-matrix">Building G ensemble matrix</a><a id="Building-G-ensemble-matrix-1"></a><a class="docs-heading-anchor-permalink" href="#Building-G-ensemble-matrix" title="Permalink"></a></h1><div class="admonition is-warning" id="Warning-1fabbdba08686208"><header class="admonition-header">Warning<a class="admonition-anchor" href="#Warning-1fabbdba08686208" title="Permalink"></a></header><div class="admonition-body"><p>To enable this module, use <code>using ClimaAnalysis</code> or <code>import ClimaAnalysis</code>.</p></div></div><div class="admonition is-info" id="Prerequisites-2914b1d510801038"><header class="admonition-header">Prerequisites<a class="admonition-anchor" href="#Prerequisites-2914b1d510801038" title="Permalink"></a></header><div class="admonition-body"><p>This module assumes that you are using <code>ObservationRecipe</code> to make your observations and <code>ClimaAnalysis</code> to preprocess your simulation data. If this is not the case, this module is not for you.</p></div></div><div class="admonition is-info" id="Version-of-ClimaAnalysis-f6280de1bd83a317"><header class="admonition-header">Version of ClimaAnalysis<a class="admonition-anchor" href="#Version-of-ClimaAnalysis-f6280de1bd83a317" title="Permalink"></a></header><div class="admonition-body"><p>This module requires a version of ClimaAnalysis greater than v0.5.19.</p></div></div><div class="admonition is-info" id="Other-documentation-6c29de9bb32b601"><header class="admonition-header">Other documentation<a class="admonition-anchor" href="#Other-documentation-6c29de9bb32b601" title="Permalink"></a></header><div class="admonition-body"><p>It may be helpful to review the documentation for <a href="https://clima.github.io/ClimaAnalysis.jl/dev/flat/"><code>FlatVar</code></a> in ClimaAnalysis and <a href="../observation_recipe/#ObservationRecipe"><code>ObservationRecipe</code></a> in ClimaCalibrate.</p></div></div><p>To help with constructing G ensemble matrix when using <code>ObservationRecipe</code>, <code>ClimaCalibrate</code> provides the struct <code>GEnsembleBuilder</code> and its related functions to easily create G ensemble matrix using the metadata stored in the observation. The metadata stores a rich amount of information that enables comprehensive validation and checking between simulation and observational data.</p><p>The metadata stored in the observations enable an automatic process of flattening or vectorizing your <code>OutputVar</code> and filling out your G ensemble matrix with consistency checks between the simulation data and observational data. This eliminates user errors, such as checking for the ordering of the dimensions when flattening the <code>OutputVar</code>, checking that the dimensions are consistent, and checking the units between observational and simulation data.</p><h2 id="GEnsembleBuilder"><a class="docs-heading-anchor" href="#GEnsembleBuilder"><code>GEnsembleBuilder</code></a><a id="GEnsembleBuilder-1"></a><a class="docs-heading-anchor-permalink" href="#GEnsembleBuilder" title="Permalink"></a></h2><p>To construct a <a href="../api/#ClimaCalibrate.EnsembleBuilder.GEnsembleBuilder"><code>GEnsembleBuilder</code></a>, you pass the <code>EKP.EnsembleKalmanProcess</code> object to the constructor.</p><pre><code class="language-julia hljs">import ClimaCalibrate
import ClimaAnalysis # needed to enable extension
import ClimaCalibrate.EnsembleBuilder

# ekp is a EnsembleKalmanProcesses.EnsembleKalmanProcess object
g_ens_builder = EnsembleBuilder.GEnsembleBuilder(ekp)</code></pre><p>Then, in your observation map of your calibration, you should preprocess your <code>OutputVar</code>s using <code>ClimaAnalysis</code>. For a CliMA simulation, this involves using <code>SimDir</code> to load the NetCDF files as <code>OutputVar</code>s and preprocessing them, so that they match the <code>OutputVar</code>s that are used to create the observations.</p><div class="admonition is-info" id="Short-names-1a60b638d71aa871"><header class="admonition-header">Short names<a class="admonition-anchor" href="#Short-names-1a60b638d71aa871" title="Permalink"></a></header><div class="admonition-body"><p>Using <code>GEnsembleBuilder</code> requires attaching a short name to all <code>OutputVar</code>s for both simulation and observational data. The empty string cannot be used as a short name. Without the short name, it is not possible to determine which simulation data match with which observational data. Furthermore, the short names should be unique. For example, if you are calibrating monthly minimum and maximum of precipitation, then the short name for the monthly minimum can be <code>pr_min</code> and the short name for the monthly maximum can be <code>pr_max</code>.</p></div></div><p>In particular, the <code>OutputVar</code>s from the simulation data should match the <code>OutputVar</code>s from the observations from</p><ul><li>the short name (see <a href="https://clima.github.io/ClimaAnalysis.jl/dev/api/#ClimaAnalysis.Var.short_name"><code>ClimaAnalysis.short_name</code></a>),</li><li>the non-temporal dimensions,</li><li>the dates of the simulation data includes all the dates of one or more metadata in the observations,</li><li>the units of the variables.</li></ul><p>For more information about the checks that are performed, see the <a href="#checkers">Checkers</a> section.</p><div class="admonition is-info" id="Spinup-and-windowing-times-646eeb412cdf3871"><header class="admonition-header">Spinup and windowing times<a class="admonition-anchor" href="#Spinup-and-windowing-times-646eeb412cdf3871" title="Permalink"></a></header><div class="admonition-body"><p>Internally, the correct dates are matched between the observational and simulation data. As a result, you do not need to window the times (e.g. when removing spinup) to match the times of the observations.</p></div></div><div class="admonition is-warning" id="Matching-dates-d2a3828c333b3f5c"><header class="admonition-header">Matching dates<a class="admonition-anchor" href="#Matching-dates-d2a3828c333b3f5c" title="Permalink"></a></header><div class="admonition-body"><p>There are no checks for how dates are matched which can easily lead to errors. For example, if the simulation data contain monthly averages and metadata track seasonal averages, then no error is thrown, because all dates in <code>metadata</code> are in all the dates in <code>var</code>.</p><p>For these reasons, it is recommended to pass <a href="../api/#ClimaCalibrate.Checker.SequentialIndicesChecker"><code>SequentialIndicesChecker</code></a> to the <code>checkers</code> keyword argument of <a href="../api/#ClimaCalibrate.EnsembleBuilder.fill_g_ens_col!"><code>fill_g_ens_col!</code></a> which will check that the dates used to fill the G ensemble matrix correspond to sequential indices in the simulation data.</p></div></div><p>After preprocessing the <code>OutputVar</code>s, you can call <a href="../api/#ClimaCalibrate.EnsembleBuilder.fill_g_ens_col!"><code>fill_g_ens_col!</code></a> to fill the G ensemble matrix using the <code>OutputVars</code>.</p><pre><code class="language-julia hljs"># -- preprocessing OutputVars from the first ensemble member--
# var1, var2, and var3 are OutputVars of different quantities
# The second argument is which column of the G ensemble matrix to fill out
vars = (var1, var2, var3)
for var in vars
    EnsembleBuilder.fill_g_ens_col!(g_ens_builder, 1, var)
end</code></pre><p>In this example, all the <code>OutputVar</code>s of a single ensemble member are preprocessed and pass to <code>fill_g_ens_col!</code> in a loop. On the other hand, one can preprocess a single <code>OutputVar</code>, pass it to <code>fill_g_ens_col!</code>, and repeat for all the other <code>OutputVar</code>s. We recommend the latter approach as loading all the <code>OutputVar</code>s simultaneously can consume a lot of memory.</p><div class="admonition is-info" id="Unused-OutputVars-92ce7ad13bec684b"><header class="admonition-header">Unused OutputVars<a class="admonition-anchor" href="#Unused-OutputVars-92ce7ad13bec684b" title="Permalink"></a></header><div class="admonition-body"><p>If a <code>OutputVar</code> is passed to <code>fill_g_ens_col!</code> and it is not used, an error will not be thrown, but a <em>warning</em> will be thrown instead.</p></div></div><p>Next, you can check if the G ensemble matrix is filled out with <a href="../api/#ClimaCalibrate.EnsembleBuilder.is_complete"><code>is_complete</code></a> which returns <code>true</code> if the G ensemble matrix is completed and <code>false</code> otherwise.</p><pre><code class="language-julia hljs">EnsembleBuilder.is_complete(g_ens_builder)</code></pre><p>If this returns <code>false</code>, then you should review the warnings to determine why a <code>OutputVar</code> is not used to fill out the G ensemble matrix.</p><p>Finally, you can get the G ensemble matrix with <a href="../api/#ClimaCalibrate.EnsembleBuilder.get_g_ensemble"><code>get_g_ensemble</code></a> and return it from <code>ClimaCalibrate.observation_map</code>.</p><pre><code class="language-julia hljs">g_ens = EnsembleBuilder.get_g_ensemble(g_ens_builder)</code></pre><h1 id="Checkers"><a class="docs-heading-anchor" href="#Checkers">Checkers</a><a id="Checkers-1"></a><a class="docs-heading-anchor-permalink" href="#Checkers" title="Permalink"></a></h1><p>To determine whether a <code>OutputVar</code> matches with a metadata, <code>GEnsembleBuilder</code> uses <code>Checker</code>s to check and compare the contents of a <code>OutputVar</code> and with that of the metadata. For example, the short names are checked between the <code>OutputVar</code> and metadata with <a href="../api/#ClimaCalibrate.Checker.ShortNameChecker"><code>ShortNameChecker</code></a>.</p><h2 id="Built-in-checkers"><a class="docs-heading-anchor" href="#Built-in-checkers">Built-in checkers</a><a id="Built-in-checkers-1"></a><a class="docs-heading-anchor-permalink" href="#Built-in-checkers" title="Permalink"></a></h2><p><code>ClimaCalibrate</code> provides several built-in checkers:</p><ul><li><a href="../api/#ClimaCalibrate.Checker.ShortNameChecker"><code>ShortNameChecker</code></a>: Check that the short names match between <code>OutputVar</code> and metadata</li><li><a href="../api/#ClimaCalibrate.Checker.DimNameChecker"><code>DimNameChecker</code></a>: Check the type of dimensions are the same</li><li><a href="../api/#ClimaCalibrate.Checker.UnitsChecker"><code>UnitsChecker</code></a>: Check the variable units are the same</li><li><a href="../api/#ClimaCalibrate.Checker.DimUnitsChecker"><code>DimUnitsChecker</code></a>: Check the units of the dimensions are the same</li><li><a href="../api/#ClimaCalibrate.Checker.DimValuesChecker"><code>DimValuesChecker</code></a>: Check the values of the dimensions are the same</li><li><a href="../api/#ClimaCalibrate.Checker.SequentialIndicesChecker"><code>SequentialIndicesChecker</code></a>: Check the indices of the dates of the simulation data corresponding to the dates of the metadata is sequential.</li></ul><p>By default, <code>GEnsembleBuilder</code> uses the first five checkers to validate compatibility between . You can also provide additional checkers using the <code>checkers</code> keyword argument in <code>fill_g_ens_col!</code>:</p><pre><code class="language-julia hljs"># Use additional checker for sequential indices
EnsembleBuilder.fill_g_ens_col!(
    g_ens_builder,
    1, 
    var,
    checkers = (SequentialIndicesChecker(),)
)</code></pre><h2 id="Implementing-custom-checkers"><a class="docs-heading-anchor" href="#Implementing-custom-checkers">Implementing custom checkers</a><a id="Implementing-custom-checkers-1"></a><a class="docs-heading-anchor-permalink" href="#Implementing-custom-checkers" title="Permalink"></a></h2><p>To create a custom checker, define a struct that inherits from <code>AbstractChecker</code> and implement the <code>check</code> method:</p><pre><code class="language-julia hljs">import ClimaCalibrate.Checker

# Define your custom checker
struct NothingChecker &lt;: Checker.AbstractChecker end

# Implement the check method
function Checker.check(
    ::NothingChecker,
    var,
    metadata;
    verbose = false
)
    verbose &amp;&amp; @info &quot;This is always true.&quot;
    return true
end</code></pre><p>The <code>Checker.check</code> function should</p><ul><li>accept a checker instance, an <code>OutputVar</code>, and <code>Metadata</code>,</li><li>return <code>true</code> if the check passes, <code>false</code> otherwise,</li><li>and optionally log informative messages when <code>verbose = true</code>.</li></ul><p>For more information about <code>OutputVar</code> and <code>Metadata</code>, see the <a href="https://clima.github.io/ClimaAnalysis.jl/dev/">ClimaAnalysis documentation</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../observation_recipe/">« Observation Recipes</a><a class="docs-footer-nextpage" href="../emulate_sample/">Emulate and Sample »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Wednesday 8 October 2025 18:46">Wednesday 8 October 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
